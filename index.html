<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE IRON SAGA | Identity Progression Engine</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Almendra:wght@400;700&family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        :root {
            --blood-red: #8b0000;
            --parchment: #d2b48c;
            --stone-dark: #121212;
            --wood-trim: #3e2723;
            --gold: #c5a059;
            --iron: #757575;
            --exp-glow: #00ffcc;
            --victory-green: #2e7d32;
            --hp-green: #4caf50;
            --mana-blue: #2196f3;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--stone-dark);
            color: var(--parchment);
            font-family: 'Almendra', serif;
            background-image: url('https://www.transparenttextures.com/patterns/dark-leather.png');
            line-height: 1.4;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .container { max-width: 600px; margin: 0 auto; padding: 10px; padding-bottom: 80px; }

        header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 3px double var(--wood-trim);
            margin-bottom: 15px;
        }

        .avatar-circle {
            width: 85px;
            height: 85px;
            margin: 0 auto;
            border: 3px solid var(--gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2rem;
            background: radial-gradient(circle, var(--wood-trim) 0%, #111 100%);
            box-shadow: 0 0 20px rgba(197, 160, 89, 0.3);
            font-family: 'MedievalSharp';
            transition: transform 0.3s ease;
        }

        h1 { font-family: 'MedievalSharp'; color: var(--gold); margin: 12px 0 2px; font-size: 1.8rem; letter-spacing: 1px; }
        .identity-subtitle { font-style: italic; color: var(--iron); font-size: 0.9rem; letter-spacing: 0.5px; }

        .player-bars { margin: 10px auto; max-width: 300px; display: flex; flex-direction: column; gap: 8px; }
        .bar-label { display: flex; justify-content: space-between; font-size: 0.65rem; font-family: 'MedievalSharp'; letter-spacing: 1px; }
        .bar-container { height: 8px; background: #000; border: 1px solid #333; border-radius: 4px; overflow: hidden; }
        .hp-fill { height: 100%; background: linear-gradient(90deg, #1b5e20, var(--hp-green)); transition: width 0.5s ease; }
        .mana-fill { height: 100%; background: linear-gradient(90deg, #0d47a1, var(--mana-blue)); transition: width 0.5s ease; }

        .resources {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            font-size: 0.75rem;
            color: var(--gold);
        }

        .header-progression {
            max-width: 300px;
            margin: 15px auto 5px;
            padding: 10px;
            border: 1px solid rgba(0, 255, 204, 0.2);
            background: rgba(0,0,0,0.3);
        }

        .boss-raid {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--blood-red);
            padding: 12px;
            margin-bottom: 15px;
            text-align: center;
            border-radius: 4px;
        }

        .hp-container { height: 12px; background: #000; border: 1px solid #444; margin: 8px 0; overflow: hidden; }
        .boss-hp-fill { height: 100%; background: linear-gradient(90deg, #600, #b00); transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
        .boss-victory { color: var(--exp-glow); font-family: 'MedievalSharp'; display: none; padding: 10px; }

        .trial-banner {
            background: linear-gradient(45deg, #1a1a1a, #2a2010);
            border: 1px solid var(--gold);
            padding: 10px;
            margin-bottom: 15px;
            text-align: center;
            position: relative;
        }

        nav {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.9);
            padding: 12px;
            border: 1px solid var(--wood-trim);
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        nav button {
            background: none;
            border: none;
            color: var(--iron);
            font-family: 'MedievalSharp';
            cursor: pointer;
            font-size: 0.6rem;
            transition: 0.2s;
            padding: 4px 6px;
            text-transform: uppercase;
        }

        nav button.active { color: var(--gold); text-shadow: 0 0 10px var(--gold); border-bottom: 1px solid var(--gold); }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .stat-card {
            background: rgba(25, 25, 25, 0.9);
            border: 1px solid var(--wood-trim);
            padding: 15px;
            position: relative;
            transition: transform 0.2s;
        }

        .xp-bar { height: 6px; background: #111; margin-top: 10px; border-radius: 3px; overflow: hidden; }
        .xp-fill { height: 100%; background: var(--exp-glow); transition: width 1s ease-out; }

        .header-skills {
            max-width: 300px;
            margin: 5px auto 10px;
        }
        .skills-grid { display: grid; grid-template-columns: 1fr; gap: 6px; }
        .skill-btn {
            background: rgba(13, 71, 161, 0.15);
            border: 1px solid rgba(33, 150, 243, 0.4);
            color: var(--parchment);
            padding: 8px 12px;
            text-align: left;
            font-family: 'Almendra';
            cursor: pointer;
            display: block;
            border-radius: 3px;
        }
        .skill-btn:disabled { opacity: 0.2; border-color: #222; cursor: not-allowed; }
        .skill-btn:active:not(:disabled) { background: var(--mana-blue); color: white; }
        
        .skill-header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .skill-name { font-weight: bold; font-family: 'MedievalSharp'; }
        .skill-cost { color: var(--mana-blue); font-family: 'MedievalSharp'; font-size: 0.65rem; }
        .skill-desc { font-size: 0.7rem; color: var(--iron); font-style: italic; margin-top: 2px; line-height: 1.2; display: block; }

        .page { display: none; }
        .page.active { display: block; animation: slideUp 0.4s ease-out; }

        @keyframes slideUp { from { transform: translateY(15px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .quest-item, .kill-item, .ritual-item, .miniboss-item, .store-item, .inventory-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px;
            background: rgba(30, 30, 30, 0.6);
            border-left: 5px solid var(--iron);
            margin-bottom: 10px;
            border-radius: 2px;
            position: relative;
        }

        /* --- Evolution Glow --- */
        @keyframes masterGlow {
            0% { box-shadow: 0 0 5px var(--gold); border-color: var(--gold); }
            50% { box-shadow: 0 0 20px var(--gold); border-color: #fff; }
            100% { box-shadow: 0 0 5px var(--gold); border-color: var(--gold); }
        }

        .quest-item.evolve-ready {
            animation: masterGlow 2s infinite ease-in-out;
            border-left-color: var(--gold);
            background: rgba(197, 160, 89, 0.15);
        }

        .evolve-badge {
            position: absolute;
            top: -10px;
            right: 10px;
            background: var(--gold);
            color: #000;
            font-family: 'MedievalSharp';
            font-size: 0.6rem;
            padding: 2px 8px;
            border-radius: 10px;
            box-shadow: 0 2px 5px #000;
            z-index: 5;
        }

        .store-item, .inventory-item { flex-direction: column; align-items: stretch; border-left-color: var(--gold); }
        .inventory-item { border-left-color: var(--victory-green); }

        .quest-item.completed, .kill-item.slain, .ritual-item.completed { border-left-color: var(--gold); background: rgba(20, 40, 20, 0.4); opacity: 0.8; }
        .kill-item.slain { border-left-color: var(--blood-red); text-decoration: line-through; color: var(--iron); }

        .rune-trigger, .kill-trigger, .ritual-trigger {
            width: 45px;
            height: 45px;
            border: 1px solid var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.4rem;
            background: #000;
            transition: 0.2s;
        }

        .rune-trigger.active, .ritual-trigger.active { background: var(--gold); color: #000; box-shadow: 0 0 15px var(--gold); }
        .kill-trigger:hover { background: var(--blood-red); color: white; border-color: var(--blood-red); }

        .manage-controls { display: flex; flex-direction: column; gap: 5px; margin-right: 15px; display: none; }
        .edit-active .manage-controls { display: flex; }
        .edit-active .rune-trigger, .edit-active .ritual-trigger, .edit-active .kill-trigger { display: none; }
        
        .control-btn {
            background: #111;
            border: 1px solid var(--iron);
            color: var(--parchment);
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.7rem;
        }
        .control-btn:hover { border-color: var(--gold); color: var(--gold); }
        .btn-delete { color: var(--blood-red); border-color: var(--blood-red); }
        .btn-delete:hover { background: var(--blood-red); color: white; }

        .log-box {
            max-height: 250px;
            overflow-y: auto;
            background: rgba(0,0,0,0.4);
            padding: 10px;
            border: 1px solid var(--wood-trim);
            font-size: 0.8rem;
            color: #aaa;
        }

        .log-entry { padding: 6px 0; border-bottom: 1px solid #222; }
        .log-entry b { color: var(--gold); }

        .add-form { margin-top: 25px; display: flex; flex-direction: column; gap: 10px; }
        .add-form-row { display: flex; gap: 5px; }

        input, select {
            background: #000;
            border: 1px solid var(--wood-trim);
            color: var(--parchment);
            padding: 12px;
            font-family: 'Almendra';
            flex-grow: 1;
        }

        .btn-viking {
            background: var(--blood-red);
            color: #fff;
            border: 1px solid var(--gold);
            padding: 12px 20px;
            font-family: 'MedievalSharp';
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
        }

        .btn-viking:active { transform: scale(0.98); }
        .btn-viking:disabled { opacity: 0.5; cursor: not-allowed; }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--wood-trim); }

        #custom-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: var(--stone-dark);
            border: 2px solid var(--gold);
            padding: 20px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
    </style>
</head>
<body>

<div id="custom-modal">
    <div class="modal-content">
        <h3 id="modal-title" style="margin-bottom:15px; color:var(--gold);">Scroll of Fate</h3>
        <div id="modal-body"></div>
        <div style="margin-top:20px; display:flex; gap:10px; justify-content:center;">
            <button class="btn-viking" id="modal-save">Accept</button>
            <button class="btn-viking" style="background:#444;" id="modal-cancel" onclick="closeModal()">Close</button>
        </div>
    </div>
</div>

<div class="container">
    <header>
        <div class="avatar-circle" id="avatar-icon">·ö¶</div>
        <h1 id="user-name">Leighton</h1>
        <div class="identity-subtitle" id="user-identity">Shieldbearer of the North</div>
        
        <div class="player-bars">
            <div class="vitality-block">
                <div class="bar-label" style="color:var(--hp-green);"><span>VITALITY (HP)</span><span id="player-hp-text">0 / 0</span></div>
                <div class="bar-container"><div class="hp-fill" id="player-hp-fill" style="width: 100%;"></div></div>
            </div>
            <div class="essence-block">
                <div class="bar-label" style="color:var(--mana-blue);"><span>ESSENCE (MP)</span><span id="player-mp-text">0 / 0</span></div>
                <div class="bar-container"><div class="mana-fill" id="player-mp-fill" style="width: 100%;"></div></div>
            </div>
        </div>

        <div class="resources">
            <span>·ö† Gold: <b id="res-gold">0</b></span>
            <span>·ö∫ Reputation: <b id="res-rep">0</b></span>
        </div>

        <div class="header-progression">
            <div style="display:flex; justify-content:space-between; font-size:0.7rem; font-family:'MedievalSharp'; color:var(--exp-glow);">
                <span>PLAYER LEVEL: <b id="user-level-val">1</b></span>
                <span id="user-xp-text">0 / 0 XP</span>
            </div>
            <div class="xp-bar" style="height:6px; margin-top:4px;"><div class="xp-fill" id="user-xp-fill" style="width:0%"></div></div>
        </div>

        <div class="header-skills">
            <div id="skills-container" class="skills-grid"></div>
        </div>
    </header>

    <div class="trial-banner" id="trial-display"></div>

    <div class="boss-raid">
        <div id="boss-active-ui">
            <div style="display:flex; justify-content:space-between; font-size:0.7rem;">
                <span id="boss-name-label">BOSS <span id="boss-lvl-display"></span></span>
                <span id="boss-percent">100%</span>
            </div>
            <div class="hp-container"><div id="boss-hp" class="boss-hp-fill"></div></div>
            <small id="boss-text" style="color: var(--blood-red); font-size: 0.6rem; letter-spacing: 1px;"></small>
        </div>
        <div id="boss-victory-ui" class="boss-victory">
            <h3>VICTORY!</h3>
            <button class="btn-viking" style="font-size:0.7rem; padding:8px 15px;" onclick="resetBoss()">Banish the Remains</button>
        </div>
    </div>

    <nav>
        <button onclick="showPage('longhouse')" id="nav-longhouse" class="active">DASHBOARD</button>
        <button onclick="showPage('rites')" id="nav-rites">RITES</button>
        <button onclick="showPage('rituals')" id="nav-rituals">RITUALS</button>
        <button onclick="showPage('killlist')" id="nav-killlist">KILL LIST</button>
        <button onclick="showPage('store')" id="nav-store">MARKET</button>
        <button onclick="showPage('inventory')" id="nav-inventory">INVENTORY</button>
        <button onclick="showPage('saga')" id="nav-saga">SAGA</button>
        <button onclick="showPage('runes')" id="nav-runes">RUNES</button>
    </nav>

    <!-- PAGE: LONGHOUSE -->
    <section id="longhouse" class="page active">
        <div class="stat-grid" id="stat-grid"></div>
        <div class="stat-card" style="margin-top:20px; text-align:center;">
            <p id="stoic-quote" style="font-size:0.9rem; font-style:italic; line-height:1.4; color:var(--parchment);"></p>
            <p id="stoic-author" style="font-size:0.7rem; margin-top:8px; color:var(--gold); text-transform:uppercase;"></p>
        </div>
    </section>

    <!-- PAGE: RITES -->
    <section id="rites" class="page">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3>Daily Rites</h3>
            <button class="btn-viking" id="btn-manage-rites" style="font-size:0.6rem; padding:5px 10px;" onclick="toggleManagement('rites')">Manage</button>
        </div>
        <div id="quest-list"></div>
        <div class="add-form">
            <h3 style="font-size:0.9rem;">Swear New Vow</h3>
            <div class="add-form-row">
                <input type="text" id="q-name" placeholder="Name ritual...">
                <select id="q-stat">
                    <option value="STR">STR</option><option value="INT">INT</option><option value="CHA">CHA</option>
                    <option value="DEX">DEX</option><option value="CON">CON</option><option value="WIS">WIS</option>
                </select>
            </div>
            <button class="btn-viking" onclick="createQuest()">Offer to the Gods</button>
        </div>
    </section>

    <!-- PAGE: RITUALS -->
    <section id="rituals" class="page">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3>Long-Standing Rituals</h3>
            <button class="btn-viking" id="btn-manage-rituals" style="font-size:0.6rem; padding:5px 10px;" onclick="toggleManagement('rituals')">Manage</button>
        </div>
        <div id="ritual-list"></div>
        <div class="add-form">
            <h3 style="font-size:0.9rem;">Install Routine</h3>
            <div class="add-form-row">
                <input type="text" id="rit-name" placeholder="Routine name...">
                <select id="rit-stat">
                    <option value="STR">STR</option><option value="INT">INT</option><option value="CHA">CHA</option>
                    <option value="DEX">DEX</option><option value="CON">CON</option><option value="WIS">WIS</option>
                </select>
            </div>
            <button class="btn-viking" onclick="createRitual()">Commence</button>
        </div>
    </section>

    <!-- PAGE: KILL LIST -->
    <section id="killlist" class="page">
        <h3>The Kill List</h3>
        <div id="active-miniboss-list"></div>
        <div id="active-kill-list"></div>
        <div class="add-form">
            <div class="add-form-row">
                <input type="text" id="k-name" placeholder="Target...">
                <select id="k-stat">
                    <option value="STR">STR</option><option value="INT">INT</option><option value="CHA">CHA</option>
                    <option value="DEX">DEX</option><option value="CON">CON</option><option value="WIS">WIS</option>
                </select>
            </div>
            <select id="k-miniboss" style="width:100%; margin-top:5px;"></select>
            <button class="btn-viking" style="margin-top:5px;" onclick="addKillTask()">Stake My Word</button>
        </div>
        <div class="add-form" style="background:rgba(40,10,10,0.4); border:1px solid var(--blood-red); padding:10px; margin-top:20px;">
            <h3 style="font-size:0.9rem;">Declare Warfront (Mini-Boss)</h3>
            <div class="add-form-row" style="margin-top:5px;">
                <input type="text" id="mb-name" placeholder="Project name...">
                <select id="mb-difficulty">
                    <option value="3">Skirmish (3 Tasks)</option><option value="5" selected>Siege (5 Tasks)</option><option value="10">War (10 Tasks)</option>
                </select>
            </div>
            <button class="btn-viking" style="margin-top:5px; background:var(--wood-trim);" onclick="createMiniBoss()">Sound the Horn</button>
        </div>
        <div id="completed-kill-list" style="margin-top:20px;"></div>
    </section>

    <!-- PAGE: MARKET -->
    <section id="store" class="page">
        <h3>The Artifact Merchant</h3>
        <div id="store-artifacts" style="margin-bottom:20px;"></div>
        <h3 style="border-top:1px solid var(--wood-trim); padding-top:15px;">The Spoils Peddler</h3>
        <div id="store-custom-rewards"></div>
        <div class="add-form" style="border:1px dashed var(--gold); padding:10px;">
            <div class="add-form-row">
                <input type="text" id="sr-name" placeholder="Reward">
                <input type="number" id="sr-cost" placeholder="Cost" style="width:70px;">
                <select id="sr-type" style="width:70px;"><option value="gold">Gold</option><option value="rep">Rep</option></select>
            </div>
            <button class="btn-viking" style="margin-top:5px; font-size:0.7rem;" onclick="addCustomRewardDefinition()">Add to Peddler</button>
        </div>
    </section>

    <!-- PAGE: INVENTORY -->
    <section id="inventory" class="page">
        <h3>Ancient Relics</h3>
        <div id="inv-artifacts" style="margin-bottom:20px;"></div>
        <h3 style="border-top:1px solid var(--wood-trim); padding-top:15px;">Claimed Spoils</h3>
        <div id="inv-spoils"></div>
    </section>

    <!-- PAGE: SAGA -->
    <section id="saga" class="page">
        <h3>Chronicle of Deeds</h3>
        <div class="log-box" id="saga-log"></div>
    </section>

    <!-- PAGE: RUNES -->
    <section id="runes" class="page">
        <!-- Identity Forge -->
        <div class="stat-card" style="margin-bottom:15px; border-color:var(--gold);">
            <h3 style="color:var(--gold);">The Identity Forge</h3>
            <p style="font-size:0.7rem; color:var(--iron); margin-bottom:10px;">How shall the Skalds sing of you?</p>
            <div class="add-form-row">
                <input type="text" id="name-input" placeholder="Enter new name...">
            </div>
            <button class="btn-viking" style="width:100%; margin-top:10px; font-size:0.7rem;" onclick="updateName()">Forge Name</button>
        </div>

        <div class="stat-card">
            <h3>Stone of Backup</h3>
            <button class="btn-viking" style="width:100%" onclick="exportSaga()">EXPORT JSON</button>
            <input type="file" id="importFile" onchange="importSaga(event)" style="margin-top:15px; font-size:0.7rem;">
        </div>
    </section>
</div>

<script>
    const CONFIG = {
        stats: {
            STR: { label: "Discipline", rune: "·ö¶", class: "Warrior", titles: ["Shieldbearer", "Housecarl", "The Iron Jarl"],
                   skills: [
                       {n:"Shield Bash", m:50, l:1, d:200, desc: "A heavy strike that stuns the beast. Deals 200 DMG."}, 
                       {n:"Battle Cry", m:80, l:3, d:400, desc: "Intimidate the foe and rally your spirit. Deals 400 DMG."}, 
                       {n:"Juggernaut", m:120, l:5, d:800, desc: "An unstoppable charge of pure discipline. Deals 800 DMG."}
                   ] },
            INT: { label: "Learning", rune: "·ö®", class: "Runemaster", titles: ["Scholar", "Law-Speaker", "High Runemaster"],
                   skills: [
                       {n:"Rune Fire", m:50, l:1, d:250, desc: "Ignite ancient symbols to burn the serpent. Deals 250 DMG."}, 
                       {n:"Transmute", m:80, l:3, g:50, desc: "Convert arcane energy into material wealth. Gathers 50 Gold."}, 
                       {n:"Arcane Surge", m:120, l:5, d:1000, desc: "A flood of raw knowledge and power. Deals 1000 DMG."}
                   ] },
            CHA: { label: "Influence", rune: "·ö∑", class: "Skald", titles: ["Speaker", "Lore-Singer", "Voice of Kings"],
                   skills: [
                       {n:"War Song", m:50, l:1, d:200, desc: "A rhythmic chant that weakens the foe. Deals 200 DMG."}, 
                       {n:"Heroic Ballad", m:80, l:3, r:100, desc: "Sing of great deeds to inspire the masses. Gathers 100 Rep."}, 
                       {n:"Skaldic Verse", m:120, l:5, d:700, desc: "The power of your voice shatters stone. Deals 700 DMG."}
                   ] },
            DEX: { label: "Skill", rune: "·ö±", class: "Ranger", titles: ["Apprentice", "Craftsman", "Grandmaster"],
                   skills: [
                       {n:"Precision Shot", m:50, l:1, d:250, desc: "Strike a vital point with pinpoint accuracy. Deals 250 DMG."}, 
                       {n:"Scavenge", m:80, l:3, g:40, desc: "Find hidden resources in the wild. Gathers 40 Gold."}, 
                       {n:"Arrow Rain", m:120, l:5, d:900, desc: "A flurry of arrows darkens the sky. Deals 900 DMG."}
                   ] },
            CON: { label: "Endurance", rune: "·ö¢", class: "Berserker", titles: ["Stalwart", "Stone-Skinned", "The Unbroken"],
                   skills: [
                       {n:"Reckless Strike", m:50, l:1, d:300, desc: "Sacrifice safety for raw impact. Deals 300 DMG."}, 
                       {n:"Thick Skin", m:80, l:3, h:100, desc: "Harden your resolve against pain. Restores 100 HP."}, 
                       {n:"Rampage", m:120, l:5, d:1000, desc: "A whirlwind of primal endurance. Deals 1000 DMG."}
                   ] },
            WIS: { label: "Clarity", rune: "·õü", class: "Seer", titles: ["Watcher", "Dream-Walker", "The All-Seeing"],
                   skills: [
                       {n:"Clairvoyance", m:50, l:1, x:100, desc: "See the path to your future self. Gain 100 Player XP."}, 
                       {n:"Dream Walk", m:80, l:3, d:400, desc: "Traverse the spirit realm to strike the foe. Deals 400 DMG."}, 
                       {n:"Prophecy", m:120, l:5, d:900, desc: "Fulfill the ancient decree of doom. Deals 900 DMG."}
                   ] }
        },
        xpBase: 100,
        userXPBase: 500,
        rewards: {
            xpPerRite: 25, xpPerRitual: 25, xpTrialBonus: 25, 
            xpPerKill: 10,
            playerXPPerRite: 10, playerXPPerKill: 50, playerXPPerWorldBoss: 1000,
            goldPerRite: 5, goldPerRitual: 5, goldPerKill: 25,
            repPerLevel: 50, bossVictoryGold: 500, bossVictoryRep: 250,
            userLevelUpGold: 100, userLevelUpRep: 100
        }
    };

    const BOSS_POOL = [
        { name: "J√∂rmungandr", title: "The World Serpent", icon: "üêç" },
        { name: "Fenrir", title: "The Bound Wolf", icon: "üê∫" },
        { name: "N√≠√∞h√∂ggr", title: "The Dragon of Roots", icon: "üêâ" },
        { name: "Garmr", title: "The Hound of Hel", icon: "üêï" },
        { name: "Surtr", title: "Bringer of Ragnar√∂k", icon: "üî•" }
    ];

    const ARTIFACT_POOL = [
        { id: 101, name: "Thor's Gauntlet", stat: "STR", bonus: 2, cost: 200, type: "gold" },
        { id: 102, name: "Eye of Odin", stat: "WIS", bonus: 3, cost: 500, type: "rep" },
        { id: 103, name: "Brisingamen's Link", stat: "CHA", bonus: 2, cost: 150, type: "gold" },
        { id: 104, name: "Drake-Skin Boots", stat: "DEX", bonus: 2, cost: 300, type: "gold" },
        { id: 105, name: "Mead of Poetry", stat: "INT", bonus: 2, cost: 200, type: "rep" }
    ];

    const STOIC_QUOTES = [
        { q: "The happiness of your life depends upon the quality of your thoughts.", a: "Marcus Aurelius" },
        { q: "We suffer more often in imagination than in reality.", a: "Seneca" },
        { q: "Waste no more time arguing about what a good man should be. Be one.", a: "Marcus Aurelius" },
        { q: "Wealth consists not in having great possessions, but in having few wants.", a: "Epictetus" },
        { q: "No man is free who is not master of himself.", a: "Epictetus" }
    ];

    let state = JSON.parse(localStorage.getItem('iron_saga_final')) || {
        userName: "Leighton",
        stats: { STR:{xp:0,lvl:1}, INT:{xp:0,lvl:1}, CHA:{xp:0,lvl:1}, DEX:{xp:0,lvl:1}, CON:{xp:0,lvl:1}, WIS:{xp:0,lvl:1} },
        quests: [], rituals: [], killList: [], miniBosses: [], completedKillList: [],
        inventory: [], equippedItemIds: [], customRewards: [], ownedRewards: [],
        history: {}, logs: [{ time: Date.now(), text: "The saga begins." }],
        bossHP: 2500, bossMaxHP: 2500, bossLevel: 1, bossDefeated: false, 
        gold: 0, rep: 0, 
        userLevel: 1, userXP: 0, userMana: 100, userHP: 100,
        lastCheckedDate: new Date().toISOString().split('T')[0],
        lastSundayReset: getPreviousSunday().toISOString(),
        lastAutoBackupDate: null
    };

    if (!state.userName) state.userName = "Leighton";

    let managementMode = { rites: false, rituals: false };

    function save() {
        clampResources();
        localStorage.setItem('iron_saga_final', JSON.stringify(state));
        render();
    }

    function clampResources() {
        const maxHP = calculateMaxHP();
        const maxMP = calculateMaxMana();
        if (state.userHP > maxHP) state.userHP = maxHP;
        if (state.userMana > maxMP) state.userMana = maxMP;
    }

    function getPreviousSunday() {
        const d = new Date();
        const day = d.getDay();
        const diff = d.getDate() - day;
        const lastSun = new Date(d.setDate(diff));
        lastSun.setHours(23, 59, 0, 0);
        return lastSun;
    }

    function checkDailyResets() {
        const todayStr = new Date().toISOString().split('T')[0];
        if (state.lastAutoBackupDate !== todayStr) {
            triggerMorningAutoBackup(todayStr);
        }
        if (getPreviousSunday() > new Date(state.lastSundayReset)) {
            state.completedKillList = [];
            state.lastSundayReset = getPreviousSunday().toISOString();
        }
        state.lastCheckedDate = todayStr;
        save();
    }

    function triggerMorningAutoBackup(todayStr) {
        document.getElementById('modal-title').innerText = "The Morning Forge";
        document.getElementById('modal-body').innerHTML = `
            <p>A new day dawns. Preserving your legend...</p>
            <div style="font-size:2rem; margin:15px 0;">üî®üìú</div>
            <p style="font-size:0.8rem; color:var(--iron);">Forging a daily save to protect your progress.</p>
        `;
        document.getElementById('modal-cancel').style.display = 'none';
        document.getElementById('modal-save').innerText = "Vouchsafe My Saga";
        document.getElementById('modal-save').onclick = () => {
            state.lastAutoBackupDate = todayStr;
            exportSaga("auto_save_" + todayStr);
            closeModal();
        };
        document.getElementById('custom-modal').style.display = 'flex';
    }

    function calculateMaxMana() {
        const intTot = getStatTotal('INT').total;
        const wisTot = getStatTotal('WIS').total;
        return (intTot * 15) + (wisTot * 10) + (state.userLevel * 20);
    }

    function calculateMaxHP() {
        const strTotal = getStatTotal('STR').total;
        const conTotal = getStatTotal('CON').total;
        return (conTotal * 20) + (strTotal * 10) + (state.userLevel * 50);
    }

    function getStatTotal(statKey) {
        let base = state.stats[statKey].lvl;
        let bonus = 0;
        state.equippedItemIds.forEach(iid => {
            const item = state.inventory.find(i => i.instanceId === iid);
            if (item && item.stat === statKey) bonus += item.bonus;
        });
        return { base, bonus, total: base + bonus };
    }

    function addUserXP(amount) {
        state.userXP += amount;
        const required = state.userLevel * CONFIG.userXPBase;
        if (state.userXP >= required) {
            state.userXP -= required;
            state.userLevel++;
            state.gold += CONFIG.rewards.userLevelUpGold;
            state.rep += CONFIG.rewards.userLevelUpRep;
            addLog(`ASCENSION! Player Level ${state.userLevel}.`);
        }
    }

    function updateName() {
        const input = document.getElementById('name-input');
        if (input.value.trim()) {
            state.userName = input.value.trim();
            addLog(`The Identity Forge has cooled. Your name is now <b>${state.userName}</b>.`);
            input.value = '';
            save();
        }
    }

    function toggleQuest(id, stat) {
        const today = new Date().toISOString().split('T')[0];
        if (!state.history[today]) state.history[today] = {};
        const isComp = !state.history[today][id];
        state.history[today][id] = isComp;
        if (isComp) {
            addXP(stat, CONFIG.rewards.xpPerRite + (stat === currentTrialStat ? CONFIG.rewards.xpTrialBonus : 0));
            addUserXP(CONFIG.rewards.playerXPPerRite);
            state.userMana = Math.min(calculateMaxMana(), state.userMana + 10);
            state.gold += CONFIG.rewards.goldPerRite;
            state.bossHP = Math.max(0, state.bossHP - 35);
            checkBossDefeat();
        }
        save();
    }

    function toggleRitual(id, stat) {
        const today = new Date().toISOString().split('T')[0];
        if (!state.history[today]) state.history[today] = {};
        const isComp = !state.history[today][id];
        state.history[today][id] = isComp;
        const rit = state.rituals.find(r => r.id === id);
        if (isComp) {
            rit.completions++;
            addXP(stat, CONFIG.rewards.xpPerRitual);
            addUserXP(CONFIG.rewards.playerXPPerRite);
            state.userMana = Math.min(calculateMaxMana(), state.userMana + 10);
            state.gold += CONFIG.rewards.goldPerRitual;
            state.bossHP = Math.max(0, state.bossHP - 35);
            checkBossDefeat();
        }
        save();
    }

    function castSkill(skillIndex, statKey) {
        const skill = CONFIG.stats[statKey].skills[skillIndex];
        if (state.userMana < skill.m) return;
        state.userMana -= skill.m;
        if (skill.d) state.bossHP = Math.max(0, state.bossHP - skill.d);
        if (skill.g) state.gold += skill.g;
        if (skill.r) state.rep += skill.r;
        if (skill.x) addUserXP(skill.x);
        if (skill.h) state.userHP = Math.min(calculateMaxHP(), state.userHP + skill.h);
        addLog(`Used <b>${skill.n}</b>. ${skill.desc}`);
        checkBossDefeat();
        save();
    }

    function addXP(stat, amount) {
        let s = state.stats[stat];
        s.xp += amount;
        if (s.xp >= (s.lvl * CONFIG.xpBase)) {
            s.xp -= (s.lvl * CONFIG.xpBase);
            s.lvl++;
            state.rep += CONFIG.rewards.repPerLevel;
            addLog(`LEVEL UP! ${stat} is now ${s.lvl}.`);
        }
    }

    function checkBossDefeat() {
        if (state.bossHP <= 0 && !state.bossDefeated) {
            state.bossDefeated = true;
            state.gold += CONFIG.rewards.bossVictoryGold;
            state.rep += CONFIG.rewards.bossVictoryRep;
            addUserXP(CONFIG.rewards.playerXPPerWorldBoss);
            document.getElementById('modal-title').innerText = `FOE VANQUISHED`;
            document.getElementById('modal-body').innerHTML = `<p>+1000 Player XP, +500 Gold, +250 Rep</p>`;
            document.getElementById('custom-modal').style.display = 'none';
            document.getElementById('modal-save').innerText = "Accept Glory";
            document.getElementById('custom-modal').style.display = 'flex';
            document.getElementById('modal-save').onclick = closeModal;
        }
    }

    function resetBoss() {
        state.bossLevel++; state.bossMaxHP += 750; state.bossHP = state.bossMaxHP; state.bossDefeated = false; save();
    }

    function buyArtifact(id) {
        const item = ARTIFACT_POOL.find(i => i.id === id);
        if (state[item.type] >= item.cost) {
            state[item.type] -= item.cost;
            state.inventory.push({ ...item, instanceId: Date.now() });
            save();
        }
    }

    function createMiniBoss() {
        const name = document.getElementById('mb-name').value;
        const hp = parseInt(document.getElementById('mb-difficulty').value);
        if(!name) return;
        const rewardMap = { "3": { label: "Skirmish", g: 50, r: 50, x: 100 }, "5": { label: "Siege", g: 150, r: 150, x: 300 }, "10": { label: "War", g: 500, r: 500, x: 1000 } };
        state.miniBosses.push({ id: Date.now(), name, maxHP: hp, currentHP: hp, defeated: false, rewards: rewardMap[hp] });
        document.getElementById('mb-name').value = '';
        save();
    }

    function addKillTask() {
        const name = document.getElementById('k-name').value;
        const stat = document.getElementById('k-stat').value;
        const mbId = document.getElementById('k-miniboss').value;
        if(name) state.killList.push({ id: Date.now(), name, stat, miniBossId: mbId ? parseInt(mbId) : null });
        save();
    }

    function slayTask(id) {
        const idx = state.killList.findIndex(k => k.id === id);
        const task = state.killList[idx];
        if (task.miniBossId) {
            const mb = state.miniBosses.find(b => b.id === task.miniBossId);
            if (mb) {
                mb.currentHP--;
                if (mb.currentHP <= 0 && !mb.defeated) {
                    mb.defeated = true;
                    state.gold += mb.rewards.g;
                    state.rep += mb.rewards.r;
                    addUserXP(mb.rewards.x);
                    addLog(`WARFRONT VANQUISHED: ${mb.name}!`);
                }
            }
        }
        state.killList.splice(idx, 1);
        state.completedKillList.push(task);
        addXP(task.stat, CONFIG.rewards.xpPerKill);
        addUserXP(CONFIG.rewards.playerXPPerKill); 
        state.gold += CONFIG.rewards.goldPerKill; 
        state.bossHP = Math.max(0, state.bossHP - 150);
        checkBossDefeat(); save();
    }

    function addLog(text) {
        state.logs.unshift({ time: Date.now(), text });
        if (state.logs.length > 40) state.logs.pop();
    }

    function toggleManagement(type) {
        managementMode[type] = !managementMode[type];
        document.getElementById(`btn-manage-${type}`).innerText = managementMode[type] ? 'Done' : 'Manage';
        render();
    }

    function closeModal() { document.getElementById('custom-modal').style.display = 'none'; }

    // --- NEW: STREAK CALCULATION ---
    function getStreak(questId) {
        let streak = 0;
        const d = new Date();
        // Check backwards
        while (true) {
            const dateStr = d.toISOString().split('T')[0];
            if (state.history[dateStr] && state.history[dateStr][questId]) {
                streak++;
                d.setDate(d.getDate() - 1);
            } else {
                // If it's today and not yet done, we check yesterday to see if streak is still alive
                const todayStr = new Date().toISOString().split('T')[0];
                if (dateStr === todayStr) {
                    d.setDate(d.getDate() - 1);
                    continue;
                }
                break;
            }
        }
        return streak;
    }

    function openEvolveRite(id) {
        const quest = state.quests.find(q => q.id === id);
        if (!quest) return;

        document.getElementById('modal-title').innerText = "THE FORGE OF EVOLUTION";
        document.getElementById('modal-body').innerHTML = `
            <p>You have mastered this ritual. How shall you raise the bar?</p>
            <input type="text" id="evolve-name-input" value="${quest.name}" style="width:100%; margin-top:10px;">
            <p style="font-size:0.7rem; color:var(--iron); margin-top:5px;">Your streak will continue as you transcend to higher discipline.</p>
        `;
        document.getElementById('modal-cancel').style.display = 'block';
        document.getElementById('modal-save').innerText = "Raise the Bar";
        document.getElementById('modal-save').onclick = () => {
            const newName = document.getElementById('evolve-name-input').value.trim();
            if (newName) {
                const oldName = quest.name;
                quest.name = newName;
                addLog(`EVOLUTION: <b>${oldName}</b> has become <b>${newName}</b>.`);
                closeModal();
                save();
            }
        };
        document.getElementById('custom-modal').style.display = 'flex';
    }

    function render() {
        const today = new Date().toISOString().split('T')[0];
        const boss = BOSS_POOL[(state.bossLevel - 1) % BOSS_POOL.length];
        const maxHP = calculateMaxHP();
        const maxMP = calculateMaxMana();

        if (state.userHP > maxHP) state.userHP = maxHP;
        if (state.userMana > maxMP) state.userMana = maxMP;

        document.getElementById('user-name').innerText = state.userName || "Leighton";
        document.getElementById('player-hp-text').innerText = `${Math.floor(state.userHP)} / ${maxHP}`;
        document.getElementById('player-hp-fill').style.width = (state.userHP / maxHP * 100) + '%';
        document.getElementById('player-mp-text').innerText = `${state.userMana} / ${maxMP}`;
        document.getElementById('player-mp-fill').style.width = (state.userMana / maxMP * 100) + '%';

        let statsData = {}; Object.keys(CONFIG.stats).forEach(k => statsData[k] = getStatTotal(k));
        const topStat = Object.entries(statsData).reduce((a, b) => a[1].total > b[1].total ? a : b)[0];
        const title = statsData[topStat].total >= 15 ? CONFIG.stats[topStat].titles[2] : (statsData[topStat].total >= 5 ? CONFIG.stats[topStat].titles[1] : CONFIG.stats[topStat].titles[0]);
        document.getElementById('user-identity').innerText = `${CONFIG.stats[topStat].class} | ${title}`;
        document.getElementById('avatar-icon').innerText = CONFIG.stats[topStat].rune;
        document.getElementById('res-gold').innerText = state.gold; document.getElementById('res-rep').innerText = state.rep;

        const reqXP = state.userLevel * CONFIG.userXPBase;
        document.getElementById('user-level-val').innerText = state.userLevel;
        document.getElementById('user-xp-text').innerText = `${state.userXP} / ${reqXP} XP`;
        document.getElementById('user-xp-fill').style.width = (state.userXP / reqXP * 100) + '%';

        const skills = CONFIG.stats[topStat].skills;
        document.getElementById('skills-container').innerHTML = skills.map((s, i) => `
            <button class="skill-btn" onclick="castSkill(${i}, '${topStat}')" ${state.userLevel < s.l || state.userMana < s.m ? 'disabled' : ''}>
                <div class="skill-header">
                    <span class="skill-name">${s.n}</span>
                    <span class="skill-cost">${s.m} MP</span>
                </div>
                <small class="skill-desc">${s.desc}</small>
            </button>
        `).join('');

        if (state.bossDefeated) {
            document.getElementById('boss-active-ui').style.display = 'none'; document.getElementById('boss-victory-ui').style.display = 'block';
        } else {
            document.getElementById('boss-active-ui').style.display = 'block'; document.getElementById('boss-victory-ui').style.display = 'none';
            document.getElementById('boss-hp').style.width = (state.bossHP / state.bossMaxHP * 100) + '%';
            document.getElementById('boss-percent').innerText = Math.round(state.bossHP/state.bossMaxHP*100) + '%';
            document.getElementById('boss-name-label').innerHTML = `${boss.icon} WORLD BOSS: ${boss.name.toUpperCase()} (LVL ${state.bossLevel})`;
            document.getElementById('boss-text').innerText = `${boss.title} | HP: ${state.bossHP}/${state.bossMaxHP}`;
        }

        document.getElementById('stat-grid').innerHTML = Object.entries(statsData).map(([k, d]) => `<div class="stat-card"><div style="display:flex; justify-content:space-between; font-size:0.7rem;"><span>${CONFIG.stats[k].label}</span><b>LVL ${d.total}</b></div><div style="font-size:1.1rem; color:var(--gold)">${k} <small style="font-size:0.6rem; color:var(--iron)">${d.bonus > 0 ? `(+${d.bonus})` : ''}</small></div><div class="xp-bar"><div class="xp-fill" style="width:${(state.stats[k].xp / (d.base * CONFIG.xpBase)) * 100}%"></div></div></div>`).join('');

        // --- Rites List Render ---
        const riteCont = document.getElementById('quest-list');
        riteCont.innerHTML = state.quests.map(q => {
            const streak = getStreak(q.id);
            const isEvolveReady = streak >= 30;
            return `
                <div class="quest-item ${state.history[today]?.[q.id] ? 'completed' : ''} ${isEvolveReady ? 'evolve-ready' : ''}">
                    ${isEvolveReady ? '<div class="evolve-badge">READY TO EVOLVE</div>' : ''}
                    <div class="manage-controls"><button class="control-btn" onclick="deleteItem('rites', ${q.id})">X</button></div>
                    <div style="flex-grow:1">
                        <b>${q.name}</b><br>
                        <small>${q.stat} Rite | Streak: ${streak}üî•</small>
                        ${isEvolveReady ? `<br><button class="btn-viking" style="font-size:0.5rem; padding:4px 8px; margin-top:5px; background:var(--gold); color:#000;" onclick="openEvolveRite(${q.id})">EVOLVE</button>` : ''}
                    </div>
                    <div class="rune-trigger ${state.history[today]?.[q.id] ? 'active' : ''}" onclick="toggleQuest(${q.id}, '${q.stat}')">${CONFIG.stats[q.stat].rune}</div>
                </div>
            `;
        }).join('');
        
        const ritCont = document.getElementById('ritual-list');
        ritCont.innerHTML = state.rituals.map(r => `<div class="ritual-item ${state.history[today]?.[r.id] ? 'completed' : ''}"><div class="manage-controls"><button class="control-btn" onclick="deleteItem('rituals', ${r.id})">X</button></div><div style="flex-grow:1"><b>${r.name}</b><br><small>${r.stat} | C: ${r.completions}</small></div><div class="ritual-trigger ${state.history[today]?.[r.id] ? 'active' : ''}" onclick="toggleRitual(${r.id}, '${r.stat}')">${CONFIG.stats[r.stat].rune}</div></div>`).join('');

        document.getElementById('store-artifacts').innerHTML = ARTIFACT_POOL.map(item => `<div class="store-item"><div style="display:flex; justify-content:space-between;"><b>${item.name}</b><span>+${item.bonus} ${item.stat}</span></div><button class="btn-viking" style="margin-top:10px; font-size:0.6rem;" onclick="buyArtifact(${item.id})" ${state[item.type] < item.cost ? 'disabled' : ''}>BUY: ${item.cost} ${item.type.toUpperCase()}</button></div>`).join('');
        document.getElementById('inv-artifacts').innerHTML = state.inventory.map(item => `<div class="inventory-item"><div style="display:flex; justify-content:space-between; width:100%;"><span>${item.name} (+${item.bonus} ${item.stat})</span><button class="btn-viking" style="font-size:0.6rem;" onclick="toggleEquip(${item.instanceId})">${state.equippedItemIds.includes(item.instanceId) ? 'EQUIPPED' : 'EQUIP'}</button></div></div>`).join('');
        
        document.getElementById('inv-spoils').innerHTML = state.ownedRewards.map(r => `<div class="inventory-item" style="border-left-color:var(--gold);"><div style="display:flex; justify-content:space-between; width:100%;"><span>${r.name}</span><button class="btn-viking" style="font-size:0.6rem;" onclick="consumeReward(${r.instanceId})">CONSUME</button></div></div>`).join('');

        document.getElementById('active-miniboss-list').innerHTML = state.miniBosses.filter(b=>!b.defeated).map(mb => `<div class="miniboss-item"><span style="font-family:'MedievalSharp'; color:var(--gold);">${mb.rewards.label.toUpperCase()}: ${mb.name.toUpperCase()}</span><div class="hp-container" style="height:6px; margin:5px 0;"><div class="hp-fill" style="width:${mb.currentHP/mb.maxHP*100}%; background:var(--blood-red);"></div></div><small style="font-size:0.6rem;">Tasks: ${mb.currentHP}/${mb.maxHP} Remaining</small></div>`).join('');
        document.getElementById('active-kill-list').innerHTML = state.killList.map(k => `<div class="kill-item"><div><b>${k.name}</b><br><small>${k.stat} Bounty</small></div><div class="kill-trigger" onclick="slayTask(${k.id})">‚öîÔ∏è</div></div>`).join('');
        const mbSelect = document.getElementById('k-miniboss'); mbSelect.innerHTML = `<option value="">Lone Wolf Bounty</option>` + state.miniBosses.filter(b=>!b.defeated).map(mb => `<option value="${mb.id}">${mb.name}</option>`).join('');

        document.getElementById('saga-log').innerHTML = state.logs.map(l => `<div class="log-entry">[${new Date(l.time).toLocaleTimeString([],{hour:'2-digit', minute:'2-digit'})}] ${l.text}</div>`).join('');
        const quote = STOIC_QUOTES[new Date().getDate() % STOIC_QUOTES.length];
        document.getElementById('stoic-quote').innerText = `"${quote.q}"`;
        document.getElementById('stoic-author').innerText = `‚Äî ${quote.a}`;
        const trialStat = Object.keys(CONFIG.stats)[Math.floor(Date.now() / (1000 * 60 * 60 * 24 * 7)) % 6];
        document.getElementById('trial-display').innerHTML = `<span style="color:var(--gold); font-family: 'MedievalSharp';">FEAST OF ${trialStat}</span><br><small>Double XP for all ${CONFIG.stats[trialStat].label} actions.</small>`;
    }

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById('nav-' + id).classList.add('active');
        window.scrollTo(0,0);
    }

    function deleteItem(type, id) {
        if (type === 'rites') state.quests = state.quests.filter(i => i.id !== id);
        else state.rituals = state.rituals.filter(i => i.id !== id);
        save();
    }

    function exportSaga(fileNameOverride) {
        const fileName = fileNameOverride || ("iron_saga_scroll_" + new Date().toISOString().split('T')[0]);
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
        const a = document.createElement('a'); a.href = dataStr; a.download = fileName + ".json"; a.click();
    }

    function importSaga(e) {
        const reader = new FileReader();
        reader.onload = ev => { try { state = JSON.parse(ev.target.result); checkDailyResets(); render(); } catch(e) { alert("Illegible scroll."); } };
        reader.readAsText(e.target.files[0]);
    }

    const currentTrialStat = Object.keys(CONFIG.stats)[Math.floor(Date.now() / (1000 * 60 * 60 * 24 * 7)) % 6];
    checkDailyResets();
</script>
</body>
</html>
